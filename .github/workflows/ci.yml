name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

jobs:
  contracts:
    name: Contracts (Hardhat)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'
          cache-dependency-path: Hardhat/yarn.lock

      - name: Generate test account
        working-directory: ./Hardhat
        run: |
          # Generate a dummy account for testing (doesn't need real funds for compilation)
          yarn generate || echo "Account generation skipped"

      - name: Install dependencies
        working-directory: ./Hardhat
        run: yarn install --frozen-lockfile

      - name: Run ESLint
        working-directory: ./Hardhat
        run: yarn lint
        continue-on-error: true

      - name: Run Prettier check
        working-directory: ./Hardhat
        run: yarn format:check || echo "Format check skipped"
        continue-on-error: true

      - name: Compile contracts
        working-directory: ./Hardhat
        run: yarn compile
        continue-on-error: true

  frontend:
    name: Frontend (Next.js)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./Frontend
        run: npm ci

      - name: Verify Critical Package Versions
        working-directory: ./Frontend
        run: |
          echo "ðŸ” Verifying critical package versions..."
          
          # Check for compromised/vulnerable versions
          NEXT_VERSION=$(node -p "require('./package.json').dependencies.next")
          REACT_VERSION=$(node -p "require('./package.json').dependencies.react")
          REACT_DOM_VERSION=$(node -p "require('./package.json').dependencies['react-dom']")
          
          echo "Current versions:"
          echo "  Next.js: $NEXT_VERSION"
          echo "  React: $REACT_VERSION"
          echo "  React-DOM: $REACT_DOM_VERSION"
          
          # Check if versions are too old (security risk)
          if [[ "$NEXT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            NEXT_MAJOR=$(echo $NEXT_VERSION | cut -d. -f1)
            NEXT_MINOR=$(echo $NEXT_VERSION | cut -d. -f2)
            if [ "$NEXT_MAJOR" -lt 15 ] || ([ "$NEXT_MAJOR" -eq 15 ] && [ "$NEXT_MINOR" -lt 5 ]); then
              echo "âŒ ERROR: Next.js version $NEXT_VERSION is below required 15.5.7 (security update required)"
              exit 1
            fi
          fi
          
          if [[ "$REACT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            REACT_MAJOR=$(echo $REACT_VERSION | cut -d. -f1)
            if [ "$REACT_MAJOR" -lt 19 ]; then
              echo "âŒ ERROR: React version $REACT_VERSION is below required 19.2.1 (security update required)"
              exit 1
            fi
          fi
          
          echo "âœ… Critical package versions verified"

      - name: Create .env.local for build
        working-directory: ./Frontend
        run: |
          cat > .env.local << EOF
          # Shared/OnchainKit variables
          NEXT_PUBLIC_PROJECT_NAME=${{ secrets.NEXT_PUBLIC_PROJECT_NAME || secrets.NEXT_PUBLIC_ONCHAINKIT_PROJECT_NAME || 'DRVN VHCLS' }}
          # Backward compatibility: code may still use NEXT_PUBLIC_ONCHAINKIT_PROJECT_NAME
          NEXT_PUBLIC_ONCHAINKIT_PROJECT_NAME=${{ secrets.NEXT_PUBLIC_PROJECT_NAME || secrets.NEXT_PUBLIC_ONCHAINKIT_PROJECT_NAME || 'DRVN VHCLS' }}
          NEXT_PUBLIC_URL=http://localhost:3000
          NEXT_PUBLIC_ONCHAINKIT_API_KEY=${{ secrets.NEXT_PUBLIC_ONCHAINKIT_API_KEY || '' }}
          NEXT_PUBLIC_ONCHAINKIT_PROJECT_ID=${{ secrets.NEXT_PUBLIC_ONCHAINKIT_PROJECT_ID || '' }}
          
          # Redis config (optional for build)
          REDIS_URL=${{ secrets.REDIS_URL || '' }}
          REDIS_TOKEN=${{ secrets.REDIS_TOKEN || '' }}
          
          # MongoDB Database (optional for build - only needed for runtime)
          MONGODB_URI=${{ secrets.MONGODB_URI || 'mongodb://localhost:27017/test' }}
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY || '' }}
          
          # IPFS Configuration (optional for build)
          NEXT_PUBLIC_PINATA_API_KEY=${{ secrets.NEXT_PUBLIC_PINATA_API_KEY || '' }}
          NEXT_PUBLIC_PINATA_SECRET_KEY=${{ secrets.NEXT_PUBLIC_PINATA_SECRET_KEY || '' }}
          PINATA_JWT=${{ secrets.PINATA_JWT || '' }}
          NEXT_PUBLIC_IPFS_GATEWAY=${{ secrets.NEXT_PUBLIC_IPFS_GATEWAY || '' }}
          
          # Reown Wallet Key (optional for build)
          NEXT_PUBLIC_PROJECT_ID=${{ secrets.NEXT_PUBLIC_PROJECT_ID || '' }}
          
          # Alchemy API Key (optional for build)
          ALCHEMY_API_KEY=${{ secrets.ALCHEMY_API_KEY || '' }}
          NEXT_PUBLIC_BASE_RPC_URL=${{ secrets.NEXT_PUBLIC_BASE_RPC_URL || '' }}
          
          # Buster Token Variables (optional for build)
          NEXT_PUBLIC_BSTR_CONTRACT_ADDRESS=${{ secrets.NEXT_PUBLIC_BSTR_CONTRACT_ADDRESS || '' }}
          NEXT_PUBLIC_BSTR_ETH_POOL_ADDRESS=${{ secrets.NEXT_PUBLIC_BSTR_ETH_POOL_ADDRESS || '' }}
          NEXT_PUBLIC_BSTR_USDC_POOL_ADDRESS=${{ secrets.NEXT_PUBLIC_BSTR_USDC_POOL_ADDRESS || '' }}
          EOF

      - name: Run ESLint
        working-directory: ./Frontend
        run: npm run lint
        continue-on-error: true

      - name: Run Prettier check
        working-directory: ./Frontend
        run: npm run format:check || npx prettier . --check || echo "Format check skipped"

      - name: Run TypeScript type check
        working-directory: ./Frontend
        run: npm run typecheck || echo "Type checking skipped"

      - name: Build application
        working-directory: ./Frontend
        run: npm run build

